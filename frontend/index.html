<!DOCTYPE html>
<html>
<head>
<title>Bengaluru AI Traffic</title>
<meta charset="utf-8">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<style>
body{margin:0;font-family:Segoe UI}
#map{height:100vh}
.panel{position:absolute;top:10px;left:10px;background:white;padding:10px;width:260px;z-index:1000;border-radius:8px}
.route{background:#fff3cd;padding:6px;margin:4px 0;cursor:pointer}
.service{font-size:13px;border-bottom:1px solid #ddd;padding:4px}
.incident{font-size:13px;color:red}
</style>
</head>

<body>

<div class="panel">
<h3>Bengaluru AI Traffic</h3>
<button onclick="loadRoutes()">Find Best Routes</button>
<div id="routes"></div>
<hr>
<div id="servicesPanel"></div>
<hr>
<div id="incidentsPanel"></div>
</div>

<div id="map"></div>

<script>
const API="https://traffic-g8bi.onrender.com";

let map=L.map('map').setView([12.9716,77.5946],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let controls=[],currentRoutes=[];

async function loadRoutes(){
 const res=await fetch(API+"/api/routes",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({
  origin:{lat:12.9716,lng:77.5946,name:"MG Road"},
  destination:{lat:12.9352,lng:77.6245,name:"Silk Board"},
  time_of_day:"now"
 })});
 const routes=await res.json();
 currentRoutes=routes;
 document.getElementById("routes").innerHTML="";
 routes.forEach((r,i)=>{
   document.getElementById("routes").innerHTML+=
   `<div class="route" onclick="showRoute(${i})">
     ${r.name}<br>Speed: ${r.predicted_speed} km/h
   </div>`;
 });
 showRoute(0);
}

async function showRoute(i){
 controls.forEach(c=>map.removeControl(c));
 let r=currentRoutes[i];
 let ctrl=L.Routing.control({
  waypoints:r.coordinates.map(p=>L.latLng(p[0],p[1])),
  show:false,addWaypoints:false,routeWhileDragging:false
 }).addTo(map);
 controls.push(ctrl);
 await loadServices(r.route_id);
 await loadIncidents();
}

async function loadServices(id){
 const res=await fetch(API+"/api/services/"+id);
 const data=await res.json();
 const s=data.services;
 let html="<h4>Nearby Services</h4>";
 s.forEach(x=>{
  html+=`<div class="service"><b>${x.name}</b><br>${x.type} – ${x.distance_from_route} km</div>`;
 });
 document.getElementById("servicesPanel").innerHTML=html;
}

async function loadIncidents(){
 const res=await fetch(API+"/api/incidents");
 const inc=await res.json();
 let html="<h4>Incidents</h4>";
 inc.forEach(x=>{
  html+=`<div class="incident">⚠ ${x.description}</div>`;
 });
 document.getElementById("incidentsPanel").innerHTML=html;
}

setInterval(loadRoutes,600000);
loadRoutes();
</script>

</body>
</html>
