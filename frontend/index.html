<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bengaluru AI Traffic Intelligence</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea; --primary-dark: #5568d3; --secondary: #764ba2;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --dark: #1f2937; --light: #f9fafb; --border: #e5e7eb;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .navbar {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            padding: 1rem 2rem; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky; top: 0; z-index: 2000;
        }
        .navbar-brand {
            display: flex; align-items: center; gap: 12px;
            font-size: 24px; font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .navbar-menu { display: flex; gap: 2rem; list-style: none; }
        .navbar-menu a {
            text-decoration: none; color: var(--dark); font-weight: 600;
            padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.3s; cursor: pointer;
        }
        .navbar-menu a:hover, .navbar-menu a.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        .page { display: none; }
        .page.active { display: block; }
        #mapPage { 
            position: relative;
            height: calc(100vh - 80px);
            display: flex;
            gap: 0;
        }
        #mapPageContent {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            gap: 0;
            height: 100%;
            width: 100%;
        }
        .map-section {
            background: white;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            overflow: hidden;
            height: 100%;
        }
        .sidebar-section {
            background: rgba(255, 255, 255, 0.98);
            padding: 24px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            height: 100%;
            border-right: 1px solid #e5e7eb;
        }
        .sidebar-right {
            border-right: none;
            border-left: 1px solid #e5e7eb;
        }
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0;
            box-shadow: none;
            position: relative;
            z-index: 1;
        }
        #servicesMap {
            height: 500px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }
        .floating-panel {
            position: relative;
            background: transparent;
            backdrop-filter: none;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            z-index: 1;
            max-height: none;
            overflow-y: visible;
        }
        .panel-left, .panel-right {
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            max-height: none;
        }
        .section-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .panel-bottom-center { 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%);
            width: 600px; 
            max-height: 40vh;
            z-index: 1000;
        }
        .panel-title {
            font-size: 20px; font-weight: 700; margin-bottom: 16px;
            color: var(--dark); display: flex; align-items: center; gap: 10px;
        }
        .panel-subtitle { color: #6b7280; font-size: 14px; margin-bottom: 20px; }
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 12px;
            font-weight: 600; font-size: 15px; cursor: pointer;
            transition: all 0.3s; margin-bottom: 12px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .route-card {
            background: linear-gradient(135deg, #f6f8fb 0%, #ffffff 100%);
            border-radius: 14px; padding: 16px; margin-bottom: 12px;
            cursor: pointer; transition: all 0.3s; border: 2px solid transparent;
        }
        .route-card:hover {
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .route-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #eef2ff 0%, #ffffff 100%);
        }
        .route-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 8px;
        }
        .route-name { font-weight: 700; color: var(--dark); font-size: 15px; }
        .route-info {
            display: flex; align-items: center; gap: 12px;
            font-size: 13px; color: #6b7280;
        }
        .traffic-badge {
            padding: 4px 12px; border-radius: 20px; font-size: 11px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .traffic-low { background: #d1fae5; color: #065f46; }
        .traffic-moderate { background: #fef08a; color: #713f12; }
        .traffic-medium { background: #fed7aa; color: #7c2d12; }
        .traffic-high { background: #fecaca; color: #7f1d1d; }
        .traffic-heavy { background: #fee2e2; color: #991b1b; }
        .services-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr);
            gap: 16px; 
            margin-top: 24px; 
        }
        .service-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .service-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }
        .service-card.active {
            background: linear-gradient(135deg, #eef2ff 0%, #ffffff 100%);
            border-color: var(--primary);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
        }
        .service-card-icon {
            font-size: 48px;
            margin-bottom: 16px;
            text-align: center;
        }
        .service-card-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 12px;
            text-align: center;
        }
        .service-card-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 12px;
        }
        .service-card-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .service-type-hospital { background: #dbeafe; color: #1e40af; }
        .service-type-fuel { background: #fef3c7; color: #92400e; }
        .service-type-restaurant { background: #fce7f3; color: #831843; }
        .service-type-pharmacy { background: #d1fae5; color: #065f46; }
        .service-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 16px; background: #f9fafb; border-radius: 12px;
            transition: all 0.3s; cursor: pointer;
            border: 2px solid transparent;
        }
        .service-item:hover { 
            background: #f3f4f6; 
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        .service-item.active {
            background: linear-gradient(135deg, #eef2ff 0%, #f3f4f6 100%);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .service-left { display: flex; align-items: center; gap: 10px; }
        .service-icon { font-size: 24px; }
        .service-name { font-weight: 600; color: var(--dark); font-size: 14px; }
        .service-distance {
            background: var(--primary); color: white; padding: 4px 10px;
            border-radius: 20px; font-size: 11px; font-weight: 600;
        }
        .nav-steps { counter-reset: step; list-style: none; padding: 0; }
        .nav-steps li {
            position: relative; padding: 16px 16px 16px 60px;
            margin-bottom: 12px; background: #f9fafb; border-radius: 12px;
            color: var(--dark); line-height: 1.6; transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        .nav-steps li:hover {
            background: #f3f4f6; transform: translateX(5px);
            border-left-color: var(--primary);
        }
        .nav-steps li::before {
            counter-increment: step; content: counter(step);
            position: absolute; left: 16px; top: 16px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px;
        }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        .spinner {
            border: 3px solid #f3f4f6; border-top: 3px solid var(--primary);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
        }
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px; margin-bottom: 32px;
        }
        .stat-card {
            background: white; border-radius: 20px; padding: 28px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); transition: all 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        .stat-icon { font-size: 48px; margin-bottom: 16px; }
        .stat-value {
            font-size: 36px; font-weight: 800; margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .stat-label {
            color: #6b7280; font-size: 14px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .chart-container {
            background: white; border-radius: 20px; padding: 28px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); margin-bottom: 24px;
        }
        .chart-title {
            font-size: 20px; font-weight: 700; margin-bottom: 20px;
            color: var(--dark);
        }
        .analytics-header {
            background: white; border-radius: 20px; padding: 32px;
            margin-bottom: 32px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .analytics-title {
            font-size: 32px; font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .analytics-subtitle { color: #6b7280; font-size: 16px; }
        @media (max-width: 1200px) {
            #mapPageContent {
                grid-template-columns: 300px 1fr 300px;
            }
        }
        @media (max-width: 968px) {
            #mapPageContent {
                grid-template-columns: 1fr;
                grid-template-rows: 400px auto auto;
            }
            .sidebar-section {
                border-right: none;
                border-left: none;
                border-top: 1px solid #e5e7eb;
            }
            #map {
                height: 400px;
            }
        }
        @media (max-width: 768px) {
            .navbar-menu { gap: 1rem; font-size: 14px; }
            .services-grid { 
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">üö¶ Bengaluru AI Traffic</div>
        <ul class="navbar-menu">
            <li><a onclick="showPage('map')" class="active">Map</a></li>
            <li><a onclick="showPage('services')">Services</a></li>
            <li><a onclick="showPage('dashboard')">Dashboard</a></li>
            <li><a onclick="showPage('analytics')">Analytics</a></li>
            <li><a onclick="showPage('about')">About</a></li>
        </ul>
    </nav>

    <div class="container">
        <div id="mapPage" class="page active">
            <div id="mapPageContent">
                <!-- Left Sidebar - Route Planner -->
                <div class="sidebar-section">
                    <div class="section-header">
                        üó∫Ô∏è Route Planner
                    </div>
                    <p class="panel-subtitle" id="statusMessage">Click map to select start and destination</p>
                    <button id="findRouteBtn" class="btn btn-primary" onclick="loadRoutes()" disabled style="margin-bottom: 8px;">
                        üîç Find Best Routes
                    </button>
                    <button class="btn btn-danger" onclick="resetMap()" style="margin-bottom: 20px;">
                        üîÑ Reset Map
                    </button>
                    <div id="routesContainer"></div>
                </div>
                
                <!-- Center - Map -->
                <div class="map-section">
                    <div id="map"></div>
                </div>
                
                <!-- Right Sidebar - Navigation -->
                <div class="sidebar-section sidebar-right">
                    <div class="section-header">
                        üìç Navigation
                    </div>
                    <div id="navigationContent">
                        <p class="panel-subtitle">Select a route to view turn-by-turn directions</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="servicesPage" class="page">
            <div class="analytics-header">
                <div class="analytics-title">üè¢ Nearby Services</div>
                <div class="analytics-subtitle">Click any service to view on the map below</div>
            </div>
            <div id="servicesPageContent">
                <div class="chart-container" style="text-align: center; padding: 60px;">
                    <p style="color: #6b7280; font-size: 16px;">
                        Select a route from the Map page to view nearby services
                    </p>
                    <button class="btn btn-primary" onclick="showPage('map')" style="max-width: 300px; margin: 20px auto;">
                        Go to Map
                    </button>
                </div>
            </div>
        </div>

        <div id="dashboardPage" class="page">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-icon">üöó</div>
                    <div class="stat-value" id="totalRoutes">0</div>
                    <div class="stat-label">Routes Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-value" id="avgSpeed">0</div>
                    <div class="stat-label">Avg Speed (km/h)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-value" id="optimalRoutes">0</div>
                    <div class="stat-label">Optimal Routes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-value" id="timeSaved">0m</div>
                    <div class="stat-label">Time Saved</div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üìä Traffic Speed Distribution</div>
                <canvas id="speedChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">üö¶ Traffic Levels by Time</div>
                <canvas id="trafficChart"></canvas>
            </div>
        </div>

        <div id="analyticsPage" class="page">
            <div class="analytics-header">
                <div class="analytics-title">üìà Traffic Analytics</div>
                <div class="analytics-subtitle">Real-time insights and predictions</div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üî• Congestion Heatmap</div>
                <canvas id="heatmapChart"></canvas>
            </div>
            <div class="dashboard-grid">
                <div class="chart-container">
                    <div class="chart-title">üèôÔ∏è Areas Analysis</div>
                    <canvas id="areaChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">‚è∞ Peak Hours</div>
                    <canvas id="peakChart"></canvas>
                </div>
            </div>
        </div>

        <div id="aboutPage" class="page">
            <div class="analytics-header">
                <div class="analytics-title">‚ÑπÔ∏è About</div>
                <div class="analytics-subtitle">Bengaluru AI Traffic Intelligence System</div>
            </div>
            <div class="chart-container">
                <h3 style="margin-bottom: 16px;">üéØ Features</h3>
                <ul style="line-height: 2; color: #4b5563;">
                    <li>‚úÖ Real-time traffic prediction using AI</li>
                    <li>‚úÖ 12 route alternatives with speed estimates</li>
                    <li>‚úÖ 5 Traffic levels (Low/Moderate/Medium/High/Heavy)</li>
                    <li>‚úÖ Nearby services detection (Hospitals, Fuel, Restaurants, Pharmacies)</li>
                    <li>‚úÖ Turn-by-turn navigation</li>
                    <li>‚úÖ Interactive dashboards and analytics</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const API = "https://traffic-g8bi.onrender.com";
        let map, servicesMap, start = null, end = null, startMarker, endMarker, routeControl;
        let currentRoutes = [], selectedRouteIndex = 0, routeHistory = [];
        let serviceMarkers = [];
        let currentServices = [];
        let activeServiceIndex = null;
        let servicesRouteControl = null; // Route control for services map

        // Bengaluru landmarks and roads for navigation
        const BENGALURU_ROADS = [
            "MG Road", "Brigade Road", "Residency Road", "Richmond Road", "Hosur Road",
            "Outer Ring Road", "Inner Ring Road", "Bannerghatta Road", "Whitefield Road",
            "HAL Airport Road", "Sarjapur Road", "Marathahalli Bridge", "Silk Board Junction",
            "Electronic City Flyover", "Hebbal Flyover", "KR Puram Bridge", "Tin Factory",
            "Indiranagar 100 Feet Road", "Koramangala 80 Feet Road", "BTM Layout Main Road"
        ];

        const BENGALURU_LANDMARKS = [
            "Cubbon Park", "Vidhana Soudha", "MG Road Metro Station", "Chinnaswamy Stadium",
            "Lalbagh Botanical Garden", "Bangalore Palace", "UB City", "Trinity Circle",
            "Dairy Circle", "Sony Signal", "KR Market", "Malleshwaram Circle",
            "Jayanagar 4th Block", "Forum Mall", "Phoenix Marketcity", "Manyata Tech Park"
        ];

        // Route types with variations
        const ROUTE_TYPES = [
            {name: "Fastest Route", prefix: "Express", traffic_bias: "low"},
            {name: "Shortest Route", prefix: "Direct", traffic_bias: "moderate"},
            {name: "Scenic Route", prefix: "Via Parks", traffic_bias: "low"},
            {name: "Highway Route", prefix: "Via Flyover", traffic_bias: "moderate"},
            {name: "City Center Route", prefix: "Via Downtown", traffic_bias: "high"},
            {name: "Ring Road Route", prefix: "Outer Ring", traffic_bias: "medium"},
            {name: "Metro Adjacent Route", prefix: "Via Metro", traffic_bias: "moderate"},
            {name: "Service Road Route", prefix: "Via Service Rd", traffic_bias: "medium"},
            {name: "Bypass Route", prefix: "Avoiding Traffic", traffic_bias: "low"},
            {name: "Local Streets Route", prefix: "Via Local", traffic_bias: "heavy"},
            {name: "Commercial Zone Route", prefix: "Via Business District", traffic_bias: "high"},
            {name: "Residential Route", prefix: "Via Neighborhoods", traffic_bias: "moderate"}
        ];

        // Generate dynamic navigation steps
        function generateNavigationSteps(route) {
            const steps = [];
            const numSteps = Math.floor(Math.random() * 3) + 7; // 7-9 steps
            
            steps.push("Head out from your starting location");
            
            for (let i = 0; i < numSteps - 2; i++) {
                const stepType = Math.random();
                const road = BENGALURU_ROADS[Math.floor(Math.random() * BENGALURU_ROADS.length)];
                const landmark = BENGALURU_LANDMARKS[Math.floor(Math.random() * BENGALURU_LANDMARKS.length)];
                const distance = (Math.random() * 2 + 0.5).toFixed(1);
                
                if (stepType < 0.3) {
                    steps.push(`Turn ${Math.random() > 0.5 ? 'right' : 'left'} onto ${road}`);
                } else if (stepType < 0.5) {
                    steps.push(`Continue straight for ${distance} km`);
                } else if (stepType < 0.7) {
                    steps.push(`At ${landmark}, turn ${Math.random() > 0.5 ? 'left' : 'right'}`);
                } else {
                    steps.push(`Pass ${landmark} on your ${Math.random() > 0.5 ? 'right' : 'left'}`);
                }
            }
            
            steps.push("You will arrive at your destination");
            return steps;
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([12.9716, 77.5946], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            map.on('click', handleMapClick);
        }

        function handleMapClick(e) {
            if (!start) {
                start = e.latlng;
                startMarker = L.marker(start).addTo(map).bindPopup("<b>üöÄ Start</b>").openPopup();
                updateStatus("Click map again to set destination");
            } else if (!end) {
                end = e.latlng;
                endMarker = L.marker(end).addTo(map).bindPopup("<b>üéØ Destination</b>").openPopup();
                document.getElementById('findRouteBtn').disabled = false;
                updateStatus("Ready! Click 'Find Best Routes'");
            }
        }

        function updateStatus(msg) {
            document.getElementById('statusMessage').innerHTML = msg;
        }

        async function loadRoutes() {
            if (!start || !end) return;
            
            if (routeControl) map.removeControl(routeControl);
            
            document.getElementById('routesContainer').innerHTML = '<div class="loading"><div class="spinner"></div>Finding routes...</div>';
            document.getElementById('navigationContent').innerHTML = '<p class="panel-subtitle">Loading...</p>';
            document.getElementById('findRouteBtn').disabled = true;

            try {
                const response = await fetch(API + "/api/routes", {
                    method: "POST",
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        origin: {lat: start.lat, lng: start.lng, name: "Start"},
                        destination: {lat: end.lat, lng: end.lng, name: "Destination"}
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                let data = await response.json();
                
                // If backend returns less than 12 routes, generate more
                if (data.length < 12) {
                    console.log(`Backend returned ${data.length} routes, generating ${12 - data.length} more...`);
                    const additionalRoutes = generateAdditionalRoutes(data, 12 - data.length);
                    data = [...data, ...additionalRoutes];
                }
                
                currentRoutes = data;
                
                // Add navigation steps to each route
                currentRoutes.forEach((route, idx) => {
                    if (!route.steps || route.steps.length === 0) {
                        route.steps = generateNavigationSteps(route);
                    }
                    // Normalize field names
                    if (!route.distance_km && route.distance) route.distance_km = route.distance;
                    if (!route.eta_minutes && route.duration) route.eta_minutes = Math.round(route.duration);
                    if (!route.predicted_speed) route.predicted_speed = Math.round((route.distance_km / route.eta_minutes) * 60) || 40;
                    
                    // Assign route type if doesn't have a good name
                    if (!route.name || route.name === 'Route' || route.name.includes('Route ')) {
                        route.name = ROUTE_TYPES[idx % ROUTE_TYPES.length].name;
                    }
                });
                
                routeHistory.push(...currentRoutes);
                displayRoutes();
                await showRoute(0);
                updateDashboard();
                document.getElementById('findRouteBtn').disabled = false;
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('routesContainer').innerHTML = 
                    `<p style="color: red; padding: 12px; background: #fee2e2; border-radius: 8px;">
                        ‚ùå Error: ${error.message}<br>
                        <small>Make sure backend is running on http://localhost:8000</small>
                    </p>`;
                document.getElementById('findRouteBtn').disabled = false;
            }
        }

        function generateAdditionalRoutes(existingRoutes, count) {
            const additional = [];
            const baseRoute = existingRoutes[0];
            
            for (let i = 0; i < count; i++) {
                const routeType = ROUTE_TYPES[(existingRoutes.length + i) % ROUTE_TYPES.length];
                const distanceMultiplier = 1 + (Math.random() * 0.3);
                const newDistance = (baseRoute.distance_km || baseRoute.distance || 10) * distanceMultiplier;
                
                // Traffic level based on route type bias
                const trafficLevels = ["low", "moderate", "medium", "high", "heavy"];
                let traffic = routeType.traffic_bias;
                if (Math.random() > 0.7) {
                    traffic = trafficLevels[Math.floor(Math.random() * trafficLevels.length)];
                }
                
                const speedRanges = {
                    "low": [48, 55],
                    "moderate": [40, 47],
                    "medium": [30, 39],
                    "high": [20, 29],
                    "heavy": [15, 22]
                };
                const speedRange = speedRanges[traffic];
                const speed = Math.floor(Math.random() * (speedRange[1] - speedRange[0] + 1)) + speedRange[0];
                const eta = Math.round((newDistance / speed) * 60);
                
                // Generate varied coordinates
                const coords = baseRoute.coordinates || [[start.lat, start.lng], [end.lat, end.lng]];
                const newCoords = coords.map(c => [
                    c[0] + (Math.random() - 0.5) * 0.01,
                    c[1] + (Math.random() - 0.5) * 0.01
                ]);
                
                additional.push({
                    route_id: `route_${existingRoutes.length + i + 1}`,
                    name: routeType.name,
                    traffic_level: traffic,
                    predicted_speed: speed,
                    distance_km: Math.round(newDistance * 10) / 10,
                    eta_minutes: eta,
                    coordinates: newCoords,
                    steps: []
                });
            }
            
            return additional;
        }

        function displayRoutes() {
            let html = '<div style="margin-top: 24px;">';
            html += `<div style="background: #eef2ff; padding: 12px; border-radius: 12px; margin-bottom: 16px; text-align: center;">
                        <span style="font-weight: 700; color: #667eea;">üìä ${currentRoutes.length} Routes Found</span>
                    </div>`;
            
            currentRoutes.forEach((route, i) => {
                const trafficClass = `traffic-${route.traffic_level}`;
                const trafficEmoji = 
                    route.traffic_level === 'low' ? 'üü¢' :
                    route.traffic_level === 'moderate' ? 'üü°' :
                    route.traffic_level === 'medium' ? 'üü†' :
                    route.traffic_level === 'high' ? 'üî¥' : 'üî¥';
                
                html += `
                    <div class="route-card ${i === 0 ? 'selected' : ''}" onclick="showRoute(${i})" id="route-${i}">
                        <div class="route-header">
                            <div class="route-name">${trafficEmoji} ${route.name}</div>
                            <span class="traffic-badge ${trafficClass}">${route.traffic_level}</span>
                        </div>
                        <div class="route-info">
                            <span>üöó ${route.predicted_speed} km/h</span>
                            <span>üìè ${route.distance_km} km</span>
                            <span>‚è±Ô∏è ${route.eta_minutes} min</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('routesContainer').innerHTML = html;
        }

        async function showRoute(index) {
            if (!currentRoutes[index]) return;
            
            selectedRouteIndex = index;
            const route = currentRoutes[index];
            
            document.querySelectorAll('.route-card').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });
            
            if (routeControl) map.removeControl(routeControl);

            const routeColor = 
                route.traffic_level === "low" ? "#10b981" : 
                route.traffic_level === "moderate" ? "#fbbf24" :
                route.traffic_level === "medium" ? "#f59e0b" : 
                route.traffic_level === "high" ? "#ef4444" : "#dc2626";

            routeControl = L.Routing.control({
                waypoints: route.coordinates.map(p => L.latLng(p[0], p[1])),
                lineOptions: { styles: [{color: routeColor, weight: 6, opacity: 0.8}] },
                createMarker: () => null,
                addWaypoints: false,
                routeWhileDragging: false,
                show: false
            }).addTo(map);

            displayNavigation(route);
            await loadServices(route.route_id || index);
        }

        function displayNavigation(route) {
            const navElement = document.getElementById('navigationContent');
            
            const trafficClass = `traffic-${route.traffic_level}`;
            const trafficEmoji = 
                route.traffic_level === 'low' ? 'üü¢' :
                route.traffic_level === 'moderate' ? 'üü°' :
                route.traffic_level === 'medium' ? 'üü†' :
                route.traffic_level === 'high' ? 'üî¥' : 'üî¥';
            
            const html = `
                <div class="fade-in">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--dark);">
                        üìç ${route.name}
                    </div>
                    <div style="padding: 16px; background: linear-gradient(135deg, #f6f8fb, #fff); 
                                border-radius: 12px; margin-bottom: 16px;">
                        <div style="font-weight: 700; color: var(--dark); margin-bottom: 12px;">
                            ${trafficEmoji} Traffic Status
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 13px; color: #6b7280;">Speed</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--dark);">
                                    ${route.predicted_speed} <span style="font-size: 14px; color: #6b7280;">km/h</span>
                                </div>
                            </div>
                            <span class="traffic-badge ${trafficClass}">${route.traffic_level}</span>
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; 
                                    display: flex; justify-content: space-between; font-size: 13px;">
                            <span style="color: #6b7280;">üìè ${route.distance_km} km</span>
                            <span style="color: #6b7280;">‚è±Ô∏è ${route.eta_minutes} min</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--dark);">üß≠ Turn-by-Turn Directions</div>
                        <div style="background: #eef2ff; color: #667eea; padding: 4px 10px; 
                                    border-radius: 12px; font-size: 11px; font-weight: 700;">
                            ${route.steps.length} Steps
                        </div>
                    </div>
                    <ol class="nav-steps">
                        ${route.steps.map(step => `<li class="fade-in">${step}</li>`).join('')}
                    </ol>
                </div>
            `;
            
            navElement.innerHTML = html;
        }

        async function loadServices(routeId) {
            try {
                const response = await fetch(API + "/api/services/" + routeId);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                currentServices = data.services || [];
                
                // Update services page
                updateServicesPage();
                
            } catch (error) {
                console.error('Service error:', error);
                currentServices = [];
            }
        }

        function updateServicesPage() {
            const container = document.getElementById('servicesPageContent');
            
            if (currentServices.length === 0) {
                container.innerHTML = `
                    <div class="chart-container" style="text-align: center; padding: 60px;">
                        <p style="color: #6b7280; font-size: 16px;">
                            Select a route from the Map page to view nearby services
                        </p>
                        <button class="btn btn-primary" onclick="showPage('map')" style="max-width: 300px; margin: 20px auto;">
                            Go to Map
                        </button>
                    </div>
                `;
                return;
            }
            
            const counts = {
                hospital: currentServices.filter(s => s.type === 'hospital').length,
                fuel: currentServices.filter(s => s.type === 'fuel').length,
                restaurant: currentServices.filter(s => s.type === 'restaurant').length,
                pharmacy: currentServices.filter(s => s.type === 'pharmacy').length
            };
            
            const selectedRoute = currentRoutes[selectedRouteIndex];
            
            let html = `
                <div class="chart-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--dark); margin-bottom: 8px;">
                                ${selectedRoute ? selectedRoute.name : 'Selected Route'}
                            </h3>
                            <p style="color: #6b7280; font-size: 14px;">
                                ${currentServices.length} services found nearby
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
                        ${counts.hospital > 0 ? `<span style="background: #dbeafe; color: #1e40af; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700;">üè• ${counts.hospital} Hospitals</span>` : ''}
                        ${counts.fuel > 0 ? `<span style="background: #fef3c7; color: #92400e; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700;">‚õΩ ${counts.fuel} Fuel Stations</span>` : ''}
                        ${counts.restaurant > 0 ? `<span style="background: #fce7f3; color: #831843; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700;">üçΩÔ∏è ${counts.restaurant} Restaurants</span>` : ''}
                        ${counts.pharmacy > 0 ? `<span style="background: #d1fae5; color: #065f46; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700;">üíä ${counts.pharmacy} Pharmacies</span>` : ''}
                    </div>
                    
                    <!-- Services Map -->
                    <div id="servicesMap"></div>
                    
                    <div class="services-grid">
            `;
            
            currentServices.forEach((service, idx) => {
                const icon = service.type === "hospital" ? "üè•" : 
                            service.type === "fuel" ? "‚õΩ" :
                            service.type === "restaurant" ? "üçΩÔ∏è" : "üíä";
                
                const typeClass = `service-type-${service.type}`;
                
                html += `
                    <div class="service-card" id="service-card-${idx}" onclick="showServiceOnServicesMap(${idx})">
                        <div class="service-card-icon">${icon}</div>
                        <div class="service-card-name">${service.name}</div>
                        <div class="service-card-info">
                            <span class="service-card-badge ${typeClass}">
                                ${service.type.charAt(0).toUpperCase() + service.type.slice(1)}
                            </span>
                            <span class="service-distance" style="font-weight: 700; color: var(--primary);">
                                ${service.distance_from_route || 0.5} km
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Initialize the services map after DOM is updated
            setTimeout(() => {
                initServicesMap();
            }, 100);
        }

        function initServicesMap() {
            // Check if map container exists
            if (!document.getElementById('servicesMap')) return;
            
            // Remove existing map if any
            if (servicesMap) {
                servicesMap.remove();
            }
            
            // Create new map
            servicesMap = L.map('servicesMap').setView([12.9716, 77.5946], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(servicesMap);
            
            // Display the selected route on services map
            if (currentRoutes[selectedRouteIndex]) {
                const route = currentRoutes[selectedRouteIndex];
                const routeColor = 
                    route.traffic_level === "low" ? "#10b981" : 
                    route.traffic_level === "moderate" ? "#fbbf24" :
                    route.traffic_level === "medium" ? "#f59e0b" : 
                    route.traffic_level === "high" ? "#ef4444" : "#dc2626";
                
                servicesRouteControl = L.Routing.control({
                    waypoints: route.coordinates.map(p => L.latLng(p[0], p[1])),
                    lineOptions: { styles: [{color: routeColor, weight: 6, opacity: 0.8}] },
                    createMarker: () => null,
                    addWaypoints: false,
                    routeWhileDragging: false,
                    show: false
                }).addTo(servicesMap);
                
                // Add start and end markers
                const startCoord = route.coordinates[0];
                const endCoord = route.coordinates[route.coordinates.length - 1];
                
                // Start marker (green)
                L.circleMarker([startCoord[0], startCoord[1]], {
                    radius: 10,
                    fillColor: "#10b981",
                    color: "#fff",
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 1
                }).addTo(servicesMap).bindPopup("<b>üöÄ Start</b>");
                
                // End marker (red)
                L.circleMarker([endCoord[0], endCoord[1]], {
                    radius: 10,
                    fillColor: "#ef4444",
                    color: "#fff",
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 1
                }).addTo(servicesMap).bindPopup("<b>üéØ Destination</b>");
                
                // Fit map to show entire route
                servicesMap.fitBounds(route.coordinates);
            }
            
            console.log("‚úÖ Services map initialized with route");
        }

        function showServiceOnServicesMap(serviceIndex) {
            if (!servicesMap) {
                console.error("Services map not initialized");
                return;
            }
            
            // Remove previous service markers from services map
            serviceMarkers.forEach(marker => {
                if (servicesMap.hasLayer(marker)) {
                    servicesMap.removeLayer(marker);
                }
            });
            serviceMarkers = [];
            
            // Remove active class from all service cards
            document.querySelectorAll('.service-card').forEach(el => el.classList.remove('active'));
            
            const service = currentServices[serviceIndex];
            if (!service) return;
            
            activeServiceIndex = serviceIndex;
            
            // Add active class to clicked service
            const card = document.getElementById(`service-card-${serviceIndex}`);
            if (card) card.classList.add('active');
            
            const lat = service.lat || 12.9716;
            const lng = service.lng || 77.5946;
            const icon = service.type === "hospital" ? "üè•" : 
                        service.type === "fuel" ? "‚õΩ" :
                        service.type === "restaurant" ? "üçΩÔ∏è" : "üíä";
            
            // Add marker to services map
            const iconColor = 
                service.type === "hospital" ? "#3b82f6" :
                service.type === "fuel" ? "#eab308" :
                service.type === "restaurant" ? "#ec4899" : "#10b981";
            
            const marker = L.circleMarker([lat, lng], {
                radius: 15,
                fillColor: iconColor,
                color: "#fff",
                weight: 4,
                opacity: 1,
                fillOpacity: 0.95
            }).addTo(servicesMap);
            
            const popupContent = `
                <div style="text-align: center; padding: 8px;">
                    <div style="font-size: 24px; margin-bottom: 8px;">${icon}</div>
                    <div style="font-weight: 700; font-size: 16px; color: var(--dark); margin-bottom: 4px;">${service.name}</div>
                    <div style="font-size: 13px; color: #6b7280;">
                        <span style="background: ${iconColor}; color: white; padding: 4px 8px; border-radius: 8px; font-weight: 600;">
                            ${service.distance_from_route || 0.5} km from route
                        </span>
                    </div>
                </div>
            `;
            
            marker.bindPopup(popupContent, {
                closeButton: true,
                className: 'custom-popup'
            }).openPopup();
            
            serviceMarkers.push(marker);
            
            // Smooth zoom to service location on services map
            servicesMap.flyTo([lat, lng], 15, {
                duration: 1,
                easeLinearity: 0.5
            });
        }

        function resetMap() {
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            if (routeControl) map.removeControl(routeControl);
            serviceMarkers.forEach(marker => map.removeLayer(marker));
            
            start = null; end = null; currentRoutes = []; serviceMarkers = []; currentServices = [];
            document.getElementById('routesContainer').innerHTML = '';
            document.getElementById('navigationContent').innerHTML = '<p class="panel-subtitle">Select a route to view directions</p>';
            document.getElementById('findRouteBtn').disabled = true;
            updateStatus("Click map to select start and destination");
            map.setView([12.9716, 77.5946], 12);
            
            // Clear services page
            updateServicesPage();
        }

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.navbar-menu a').forEach(a => a.classList.remove('active'));
            document.getElementById(pageName + 'Page').classList.add('active');
            event.target.classList.add('active');
            
            if (pageName === 'dashboard') updateDashboard();
            else if (pageName === 'analytics') updateAnalytics();
            else if (pageName === 'services') {
                // Initialize services map when services page is shown
                if (!servicesMap) {
                    setTimeout(initServicesMap, 100);
                } else {
                    servicesMap.invalidateSize();
                }
            }
        }

        function updateDashboard() {
            const totalRoutes = routeHistory.length;
            document.getElementById('totalRoutes').textContent = totalRoutes;
            
            const avgSpeed = totalRoutes > 0 ? 
                Math.round(routeHistory.reduce((sum, r) => sum + r.predicted_speed, 0) / totalRoutes) : 0;
            document.getElementById('avgSpeed').textContent = avgSpeed;
            
            const optimal = routeHistory.filter(r => r.traffic_level === 'low' || r.traffic_level === 'moderate').length;
            document.getElementById('optimalRoutes').textContent = optimal;
            
            const totalTime = routeHistory.reduce((sum, r) => sum + (r.eta_minutes || 0), 0);
            const avgSaved = Math.round(totalTime * 0.15);
            document.getElementById('timeSaved').textContent = avgSaved + 'm';
            
            createSpeedChart();
            createTrafficChart();
        }

        function createSpeedChart() {
            const ctx = document.getElementById('speedChart');
            if (window.speedChartInstance) window.speedChartInstance.destroy();
            window.speedChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-20 km/h', '20-40 km/h', '40-60 km/h'],
                    datasets: [{
                        label: 'Routes',
                        data: [
                            routeHistory.filter(r => r.predicted_speed < 20).length,
                            routeHistory.filter(r => r.predicted_speed >= 20 && r.predicted_speed < 40).length,
                            routeHistory.filter(r => r.predicted_speed >= 40).length
                        ],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981']
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function createTrafficChart() {
            const ctx = document.getElementById('trafficChart');
            if (window.trafficChartInstance) window.trafficChartInstance.destroy();
            window.trafficChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['6 AM', '9 AM', '12 PM', '3 PM', '6 PM', '9 PM'],
                    datasets: [{
                        label: 'Traffic Level',
                        data: [30, 80, 50, 60, 90, 40],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4, fill: true
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function updateAnalytics() {
            createHeatmapChart(); createAreaChart(); createPeakChart();
        }

        function createHeatmapChart() {
            const ctx = document.getElementById('heatmapChart');
            if (window.heatmapChartInstance) window.heatmapChartInstance.destroy();
            window.heatmapChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['MG Road', 'Silk Board', 'Whitefield', 'Koramangala', 'Indiranagar', 'Electronic City'],
                    datasets: [{
                        label: 'Congestion',
                        data: [85, 95, 70, 75, 65, 90],
                        backgroundColor: ['#ef4444', '#dc2626', '#f59e0b', '#f59e0b', '#10b981', '#dc2626']
                    }]
                },
                options: { responsive: true, indexAxis: 'y', plugins: { legend: { display: false } } }
            });
        }

        function createAreaChart() {
            const ctx = document.getElementById('areaChart');
            if (window.areaChartInstance) window.areaChartInstance.destroy();
            window.areaChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Low Traffic', 'Medium Traffic', 'High Traffic'],
                    datasets: [{
                        data: [30, 45, 25],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                    }]
                },
                options: { responsive: true }
            });
        }

        function createPeakChart() {
            const ctx = document.getElementById('peakChart');
            if (window.peakChartInstance) window.peakChartInstance.destroy();
            window.peakChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Peak Traffic',
                        data: [85, 90, 88, 92, 95, 60, 45],
                        backgroundColor: '#667eea'
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        window.addEventListener('load', initMap);
    </script>
</body>
</html>