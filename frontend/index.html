<!DOCTYPE html>
<html>
<head>
<title>Bengaluru Traffic Intelligence System</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
body{margin:0;font-family:Arial;}
#map{height:90vh;}
#panel{
 position:absolute;top:10px;left:10px;
 background:#fff;padding:12px;border-radius:8px;
 width:260px;z-index:999;
 box-shadow:0 0 10px rgba(0,0,0,.2);
}
.route{padding:5px;border-radius:5px;margin-top:5px;cursor:pointer}
.low{background:#c8f7c5}
.medium{background:#fff3b0}
.high{background:#f7c5c5}
</style>
</head>
<body>

<div id="panel">
<h3>ğŸ—ºï¸ Bengaluru AI Traffic</h3>
<button onclick="loadRoutes()">Find Best Routes</button>
<div id="routes"></div>
<hr>
<h4>ğŸ¥ Nearby Services</h4>
<div id="services"></div>
<hr>
<h4>ğŸš§ Incidents</h4>
<div id="incidents"></div>
</div>

<div id="map"></div>

<script>
const API="https://traffic-g8bi.onrender.com";

const map=L.map("map").setView([12.9716,77.5946],11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let poly=null,routeCache={};

async function loadRoutes(){
 const res=await fetch(API+"/api/routes",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
    origin:{lat:12.9165,lng:77.6230,name:"Silk Board"},
    destination:{lat:12.9698,lng:77.7500,name:"Whitefield"},
    time_of_day:"now"
  })
 });

 const data=await res.json();
 document.getElementById("routes").innerHTML="";
 routeCache={};

 data.forEach(r=>{
   routeCache[r.route_id]=r;
   const d=document.createElement("div");
   d.className="route "+r.traffic_level;
   d.innerHTML=`${r.name}<br>
   Speed: ${r.predicted_speed.toFixed(1)} km/h`;
   d.onclick=()=>showRoute(r.route_id);
   document.getElementById("routes").appendChild(d);
 });
}

function showRoute(id){
 if(poly) map.removeLayer(poly);
 const r=routeCache[id];
 poly=L.polyline(r.coordinates,{
  color:r.traffic_level=="low"?"green":
        r.traffic_level=="medium"?"orange":"red",
  weight:5
 }).addTo(map);
 map.fitBounds(poly.getBounds());
 loadServices(id);
}

async function loadServices(id){
 const r=await fetch(API+"/api/services/"+id);
 const s=await r.json();
 document.getElementById("services").innerHTML=
  s.map(x=>`â€¢ ${x.name} (${x.type})`).join("<br>");
}

async function loadIncidents(){
 const r=await fetch(API+"/api/incidents");
 const d=await r.json();
 document.getElementById("incidents").innerHTML=
  d.map(x=>"âš  "+x.description).join("<br>");
}

setInterval(loadRoutes,600000);
setInterval(loadIncidents,600000);
loadIncidents();
</script>

</body>
</html>
